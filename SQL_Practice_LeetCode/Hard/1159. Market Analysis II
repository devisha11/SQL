/* Write an SQL query to find for each user, whether the brand of the second item (by date) they sold is their favorite brand. If a user sold less than two items, report the answer for that user as no. 
  
 It is guaranteed that no seller sold more than one item on a day. 
  
 The query result format is in the following example: 
  
 Users table: 
 +---------+------------+----------------+ 
 | user_id | join_date  | favorite_brand | 
 +---------+------------+----------------+ 
 | 1       | 2019-01-01 | Lenovo         | 
 | 2       | 2019-02-09 | Samsung        | 
 | 3       | 2019-01-19 | LG             | 
 | 4       | 2019-05-21 | HP             | 
 +---------+------------+----------------+ 
  
 Orders table: 
 +----------+------------+---------+----------+-----------+ 
 | order_id | order_date | item_id | buyer_id | seller_id | 
 +----------+------------+---------+----------+-----------+ 
 | 1        | 2019-08-01 | 4       | 1        | 2         | 
 | 2        | 2019-08-02 | 2       | 1        | 3         | 
 | 3        | 2019-08-03 | 3       | 2        | 3         | 
 | 4        | 2019-08-04 | 1       | 4        | 2         | 
 | 5        | 2019-08-04 | 1       | 3        | 4         | 
 | 6        | 2019-08-05 | 2       | 2        | 4         | 
 +----------+------------+---------+----------+-----------+ 
  
 Items table: 
 +---------+------------+ 
 | item_id | item_brand | 
 +---------+------------+ 
 | 1       | Samsung    | 
 | 2       | Lenovo     | 
 | 3       | LG         | 
 | 4       | HP         | 
 +---------+------------+ 
  
 Result table: 
 +-----------+--------------------+ 
 | seller_id | 2nd_item_fav_brand | 
 +-----------+--------------------+ 
 | 1         | no                 | 
 | 2         | yes                | 
 | 3         | yes                | 
 | 4         | no                 | 
 +-----------+--------------------+ 
  
 The answer for the user with id 1 is no because they sold nothing. 
 The answer for the users with id 2 and 3 is yes because the brands of their second sold items are their favorite brands. 
 The answer for the user with id 4 is no because the brand of their second sold item is not their favorite brand. */ 
  
  
 Code: 
 WITH cte AS 
 ( 
     SELECT o.*, i.item_brand  
     FROM orders o  
     JOIN items i 
     ON o.item_id=i.item_id 
 ), 
 cte2 AS 
 ( 
     SELECT seller_id, 'Yes' AS "2nd_item_fav_brand"  
     FROM users s  
     JOIN cte c 
     ON s.user_id=c.seller_id  
     AND s.favorite_brand=c.item_brand 
 ), 
 cte3 AS 
 ( 
     SELECT user_id, 'No' AS "2nd_item_fav_brand"  
     FROM users s  
     WHERE user_id not IN (SELECT seller_id FROM cte2) 
 ) 
 SELECT *  
 FROM cte3  
 UNION  
 SELECT *  
 FROM cte2;