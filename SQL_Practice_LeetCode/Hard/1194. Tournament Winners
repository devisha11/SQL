/*  The winner in each group is the player who scored the maximum total points within the group. In the case of a tie, the lowest player_id wins. 
  
 Write an SQL query to find the winner in each group. 
  
 The query result format is in the following example: 
  
 Players table: 
 +-----------+------------+ 
 | player_id | group_id   | 
 +-----------+------------+ 
 | 15        | 1          | 
 | 25        | 1          | 
 | 30        | 1          | 
 | 45        | 1          | 
 | 10        | 2          | 
 | 35        | 2          | 
 | 50        | 2          | 
 | 20        | 3          | 
 | 40        | 3          | 
 +-----------+------------+ 
  
 Matches table: 
 +------------+--------------+---------------+-------------+--------------+ 
 | match_id   | first_player | second_player | first_score | second_score | 
 +------------+--------------+---------------+-------------+--------------+ 
 | 1          | 15           | 45            | 3           | 0            | 
 | 2          | 30           | 25            | 1           | 2            | 
 | 3          | 30           | 15            | 2           | 0            | 
 | 4          | 40           | 20            | 5           | 2            | 
 | 5          | 35           | 50            | 1           | 1            | 
 +------------+--------------+---------------+-------------+--------------+ 
  
 Result table: 
 +-----------+------------+ 
 | group_id  | player_id  | 
 +-----------+------------+ 
 | 1         | 15         | 
 | 2         | 35         | 
 | 3         | 40         | 
 +-----------+------------+  */ 
  
  
 Code: 
 WITH cte AS 
 ( 
     SELECT first_player AS player, first_score AS score 
     FROM matches 
     UNION 
     SELECT second_player AS player, second_score AS score 
     FROM matches 
 ), 
 cte2 AS 
 ( 
     SELECT player, MAX(score) AS score 
     FROM cte 
     GROUP BY player 
 ), 
 cte3 AS 
 ( 
     SELECT player, score, group_id, dense_rank() OVER(PARTITION BY group_id ORDER BY score desc, player asc) AS rnk  
     FROM cte2 c  
     JOIN players p 
     ON c.player=p.player_id 
 ) 
 SELECT group_id, player 
 FROM cte3 
 WHERE rnk=1;